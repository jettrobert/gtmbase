name: Apify ‚Üí Clay (Google Maps ‚Üí Rows)

on:
  workflow_dispatch:   # or schedule:, push:, etc.

jobs:
  scrape-to-clay:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4   # only needed if you have input.json in the repo

      - name: Run Apify ‚Üí Send full JSON array to Clay
        env:
          APIFY_TOKEN: ${{ secrets.APIFY_TOKEN }}
          CLAY_WEBHOOK_URL: ${{ secrets.CLAY_WEBHOOK_URL }}   # ‚Üê already exists as secret
        run: |
          echo "Starting Apify Google Maps scrape..."

          # 1. Start the actor run
          RUN_JSON=$(curl -s -X POST \
            "https://api.apify.com/v2/acts/compass~google-maps-extractor/runs?token=$APIFY_TOKEN&memory=8192" \
            -H "Content-Type: application/json" \
            --data @input.json)

          RUN_ID=$(echo "$RUN_JSON" | jq -r '.data.id')
          DATASET_ID=$(echo "$RUN_JSON" | jq -r '.data.defaultDatasetId')
          echo "Run started: $RUN_ID ‚Äì waiting for it to finish..."

          # 2. Wait until SUCCEEDED
          while true; do
            STATUS=$(curl -s "https://api.apify.com/v2/actor-runs/$RUN_ID?token=$APIFY_TOKEN" \
                     | jq -r '.data.status')
            echo "Status: $STATUS"
            if [[ "$STATUS" == "SUCCEEDED" ]]; then
              echo "Scrape complete!"
              break
            elif [[ "$STATUS" == "FAILED" || "$STATUS" == "ABORTED" ]]; then
              echo "Run failed ‚Äì check the log in Apify console"
              exit 1
            fi
            sleep 7
          done

          # 3. Download the full JSON results array
          RESULTS_JSON=$(curl -s "https://api.apify.com/v2/datasets/$DATASET_ID/items?format=json&clean=1&token=$APIFY_TOKEN")

          COUNT=$(echo "$RESULTS_JSON" | jq 'length')
          echo "Found $COUNT places ‚Äì pushing to Clay..."

          # 4. Send the entire array in ONE call ‚Üí Clay creates one row per object
          curl -X POST "$CLAY_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            --data "$RESULTS_JSON"

          echo "Success! $COUNT new rows just landed in your Clay table üöÄ"
