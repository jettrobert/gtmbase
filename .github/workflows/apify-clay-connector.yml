name: Clay → Apify Google Maps → Back to Clay

on:
  workflow_dispatch:
    inputs:
      countryCode: { required: false, type: string, default: "us" }
      deeperCityScrape: { required: false, type: string, default: "true" }
      language: { required: false, type: string, default: "en" }
      skipClosedPlaces: { required: false, type: string, default: "true" }
      searchMatching: { required: false, type: string, default: "ALL" }
      placeMinimumStars: { required: false, type: string, default: "threeAndHalf" }
      website: { required: false, type: string, default: "require" }
      locationQuery: { required: true, type: string }
      maxCrawledPlacesPerSearch: { required: false, type: string, default: "50" }
      searchStringsArray: { required: false, type: string, default: "Christmas market" }

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Build correct Apify input.json
        env:
          LOCATION: ${{ inputs.locationQuery }}
          MAX: ${{ inputs.maxCrawledPlacesPerSearch }}
          TERMS: ${{ inputs.searchStringsArray }}
        run: |
          SEARCH_ARRAY=$(echo "$TERMS" | jq -R 'split(",") | map(select(length>0) | gsub("^\\s+|\\s+$";""))')
          cat > input.json << EOF
          {
            "countryCode": "us",
            "deeperCityScrape": true,
            "language": "en",
            "locationQuery": "$LOCATION",
            "maxCrawledPlacesPerSearch": ${MAX:-50},
            "searchStringsArray": $SEARCH_ARRAY,
            "skipClosedPlaces": true,
            "searchMatching": "all",
            "placeMinimumStars": "threeAndHalf",
            "website": "withWebsite",
            "memoryMbytes": 8192
          }
          EOF
          echo "Apify input ready:"
          cat input.json | jq .

      - name: Run Apify actor (never 400s)
        env:
          APIFY_TOKEN: ${{ secrets.APIFY_TOKEN }}
        run: |
          RUN_JSON=$(curl -s -X POST \
            "https://api.apify.com/v2/acts/compass~google-maps-extractor/runs?token=$APIFY_TOKEN" \
            -H "Content-Type: application/json" \
            --data @input.json)

          RUN_ID=$(echo "$RUN_JSON" | jq -r '.data.id')
          DATASET_ID=$(echo "$RUN_JSON" | jq -r '.data.defaultDatasetId')
          echo "Run started: $RUN_ID"

          while true; do
            STATUS=$(curl -s "https://api.apify.com/v2/actor-runs/$RUN_ID?token=$APIFY_TOKEN" | jq -r '.data.status')
            echo "Status: $STATUS"
            [[ "$STATUS" == "SUCCEEDED" ]] && break
            [[ "$STATUS" == "FAILED" || "$STATUS" == "ABORTED" ]] && exit 1
            sleep 7
          done

          RESULTS=$(curl -s "https://api.apify.com/v2/datasets/$DATASET_ID/items?format=json&clean=1&token=$APIFY_TOKEN")
          echo "$RESULTS" > apify-results.json

          # ← THIS IS THE ONLY CORRECT WAY TO SET MULTI-LINE OUTPUTS IN 2025
          {
            echo 'results<<EOF'
            echo "$RESULTS"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      # This is all Clay needs — no extra actions, no 422, no missing url errors
      - name: Return results to Clay
        run: |
          curl -X POST "${{ secrets.CLAY_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            --data @apify-results.json

          COUNT=$(jq 'length' apify-results.json)
          echo "SUCCESS → $COUNT new rows added to Clay!"
