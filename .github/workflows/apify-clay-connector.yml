name: Clay → Apify Google Maps → Back to Clay

# This trigger is what Clay uses when you add "Run workflow" as an enrichment
on:
  workflow_dispatch:
    inputs:
      locationQuery:
        required: true
        type: string
      maxCrawledPlacesPerSearch:
        required: false
        type: string
        default: "50"
      searchStringsArray:
        required: false
        type: string

jobs:
  scrape-and-return:
    runs-on: ubuntu-latest
    steps:
      - name: Build proper Apify input.json from Clay variables
        env:
          LOCATION_QUERY: ${{ inputs.locationQuery }}
          MAX_PLACES: ${{ inputs.maxCrawledPlacesPerSearch }}
          SEARCH_TERMS: ${{ inputs.searchStringsArray }}
        run: |
          # Turn comma-separated string into real JSON array
          SEARCH_ARRAY=$(echo "$SEARCH_TERMS" | jq -R 'split(",") | map(select(length>0) | gsub("^\\s+|\\s+$";""))')

          cat > input.json << EOF
          {
            "countryCode": "us",
            "deeperCityScrape": true,
            "language": "en",
            "locationQuery": "$LOCATION_QUERY",
            "maxCrawledPlacesPerSearch": ${MAX_PLACES:-50},
            "searchStringsArray": $SEARCH_ARRAY,
            "skipClosedPlaces": true,
            "searchMatching": "all",
            "placeMinimumStars": "threeAndHalf",
            "website": "withWebsite",
            "memoryMbytes": 8192
          }
          EOF

          echo "Final Apify input:"
          cat input.json | jq .

      - name: Run Apify (reliable method – no more 400s)
        env:
          APIFY_TOKEN: ${{ secrets.APIFY_TOKEN }}
        run: |
          RUN_JSON=$(curl -s -X POST \
            "https://api.apify.com/v2/acts/compass~google-maps-extractor/runs?token=$APIFY_TOKEN" \
            -H "Content-Type: application/json" \
            --data @input.json)

          RUN_ID=$(echo "$RUN_JSON" | jq -r '.data.id')
          DATASET_ID=$(echo "$RUN_JSON" | jq -r '.data.defaultDatasetId')
          echo "Apify run started: $RUN_ID"

          while true; do
            STATUS=$(curl -s "https://api.apify.com/v2/actor-runs/$RUN_ID?token=$APIFY_TOKEN" | jq -r '.data.status')
            echo "Status: $STATUS"
            if [[ "$STATUS" == "SUCCEEDED" ]]; then
              break
            elif [[ "$STATUS" == "FAILED" || "$STATUS" == "ABORTED" ]]; then
              echo "Run failed"
              exit 1
            fi
            sleep 7
          done

          RESULTS=$(curl -s "https://api.apify.com/v2/datasets/$DATASET_ID/items?format=json&clean=1&token=$APIFY_TOKEN")
          echo "$RESULTS" > apify-results.json
          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Return full JSON array to Clay (creates one row per place)
        id: return
        run: |
          echo "results=$(cat apify-results.json)" >> $GITHUB_OUTPUT

      # This is the magic line that sends the data back to Clay
      - name: Send results back to Clay
        if: always()
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.CLAY_WEBHOOK_URL }}
          method: POST
          contentType: application/json
          data: ${{ steps.return.outputs.results }}
