name: Apify Google Maps → Clay (One Row Per Request – Reliable Nov 2025)

on:
  workflow_dispatch:
    inputs:
      countryCode:
        type: string
        required: true
        description: "e.g. US, DE, FR"
      deeperCityScrape:
        type: boolean
        default: false
      language:
        type: string
        default: en
      locationQuery:
        type: string
        required: true
        description: "e.g. Berlin, Germany"
      maxCrawledPlacesPerSearch:
        type: string
        default: "100"
        description: "Number only, e.g. 100"
      searchStringsArray:
        type: string
        required: true
        description: "Comma-separated, e.g. dentist,orthodontist"
      skipClosedPlaces:
        type: boolean
        default: true
      searchMatching:
        type: choice
        options: [ANY, ALL]
        default: ANY
      placeMinimumStars:
        type: choice
        description: "Minimum rating (leave empty for no filter)"
        options:
          - ""
          - one
          - oneAndHalf
          - two
          - twoAndHalf
          - three
          - threeAndHalf
          - four
          - fourAndHalf
          - fourAndThreeQuarters
          - five
        default: ""
      website:
        type: choice
        options: ["", require, prefer]
        default: ""

jobs:
  scrape-and-send:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build correct input.json (strict Nov 2025 schema)
        env:
          COUNTRY_CODE: ${{ inputs.countryCode }}
          DEEPER_CITY: ${{ inputs.deeperCityScrape }}
          LANGUAGE: ${{ inputs.language }}
          LOCATION: ${{ inputs.locationQuery }}
          MAX_PLACES: ${{ inputs.maxCrawledPlacesPerSearch }}
          SEARCH_STRINGS: ${{ inputs.searchStringsArray }}
          SKIP_CLOSED: ${{ inputs.skipClosedPlaces }}
          SEARCH_MATCHING: ${{ inputs.searchMatching }}
          MIN_STARS: ${{ inputs.placeMinimumStars }}
          WEBSITE_FILTER: ${{ inputs.website }}
        run: |
          # Turn comma-separated string into real JSON array
          IFS=',' read -ra ARR <<< "$SEARCH_STRINGS"
          SEARCH_JSON=$(printf '%s\n' "${ARR[@]}" | jq -R . | jq -s -c .)

          cat << EOF > input.json
          {
            "countryCode": "$COUNTRY_CODE",
            "deeperCityScrape": $DEEPER_CITY,
            "language": "$LANGUAGE",
            "locationQuery": "$LOCATION",
            "maxCrawledPlacesPerSearch": $MAX_PLACES,
            "searchStringsArray": $SEARCH_JSON,
            "skipClosedPlaces": $SKIP_CLOSED,
            "searchMatching": "$SEARCH_MATCHING",
            "placeMinimumStars": ${MIN_STARS:-null},
            "website": "$WEBSITE_FILTER"
          }
          EOF

          echo "=== Final input.json sent to Apify ==="
          cat input.json | jq .
          echo "======================================="

      - name: Start Apify run + poll (with full error visibility)
        env:
          APIFY_TOKEN: ${{ secrets.APIFY_TOKEN }}
        run: |
          echo "Starting Apify actor run..."

          RUN_RESPONSE=$(curl -s -X POST \
            "https://api.apify.com/v2/acts/compass~google-maps-extractor/runs?token=$APIFY_TOKEN" \
            -H "Content-Type: application/json" \
            --data @input.json)

          echo "=== Raw Apify start response ==="
          echo "$RUN_RESPONSE" | jq .
          echo "================================"

          RUN_ID=$(echo "$RUN_RESPONSE" | jq -r '.data.id // empty')

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "Failed to start run – Apify rejected the input"
            echo "Check the response above for the exact validation error"
            exit 1
          fi

          echo "Run started successfully – ID: $RUN_ID"

          echo "Polling for completion (max 10 min)..."
          for i in {1..120}; do
            STATUS_RESPONSE=$(curl -s "https://api.apify.com/v2/actor-runs/$RUN_ID?token=$APIFY_TOKEN")
            STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.data.status')
            echo "Attempt $i – Status: $STATUS"

            if [ "$STATUS" = "SUCCEEDED" ]; then
              echo "Run succeeded! Downloading dataset..."
              curl -s "https://api.apify.com/v2/actor-runs/$RUN_ID/dataset/items?token=$APIFY_TOKEN&clean=true" \
                -o results.json
              break
            elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "ABORTED" ]; then
              echo "Run failed!"
              echo "$STATUS_RESPONSE" | jq .
              exit 1
            fi
            sleep 5
          done

          if [ ! -f results.json ]; then
            echo "Timeout – results not downloaded"
            exit 1
          fi

          COUNT=$(jq '. | length' results.json)
          echo "Successfully scraped $COUNT places"

      - name: Send each place individually to Clay
        env:
          CLAY_WEBHOOK: ${{ secrets.CLAY_WEBHOOK }}
        run: |
          TOTAL=$(jq '. | length' results.json)
          echo "Sending $TOTAL rows one-by-one to Clay..."

          jq -c '.[]' results.json | while read -r row; do
            echo "$row" | curl -s -X POST "$CLAY_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d @-
            sleep 0.1
          done

          echo "All $TOTAL rows successfully imported into Clay!"
