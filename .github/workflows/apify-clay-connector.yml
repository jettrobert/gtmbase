name: Run Apify Scraper and Send to Clay

on:
  workflow_dispatch:
    inputs:
      countryCode:
        type: string
        required: true
        description: "e.g. US, DE, FR"
      deeperCityScrape:
        type: boolean
        default: false
        required: true
      language:
        type: string
        default: en
        required: true
      locationQuery:
        type: string
        required: true
        description: "e.g. Berlin, Germany or Austin, TX"
      maxCrawledPlacesPerSearch:
        type: string
        default: "100"
        required: true
      searchStringsArray:
        type: string
        required: true
        description: "Comma-separated, e.g. dentist,orthodontist,dental clinic"
      skipClosedPlaces:
        type: boolean
        default: true
        required: true
      searchMatching:
        type: choice
        options: [ANY, ALL]
        default: ANY
        required: true
      placeMinimumStars:
        type: string
        default: "0"
        description: "Minimum rating, e.g. 4.0"
      website:
        type: choice
        options: ["", require, prefer]
        default: ""
        description: "Filter places with website"

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare search strings array & build input.json
        env:
          COUNTRY_CODE: ${{ inputs.countryCode }}
          DEEPER_CITY: ${{ inputs.deeperCityScrape }}
          LANGUAGE: ${{ inputs.language }}
          LOCATION: ${{ inputs.locationQuery }}
          MAX_PLACES: ${{ inputs.maxCrawledPlacesPerSearch }}
          SEARCH_STRINGS: ${{ inputs.searchStringsArray }}
          SKIP_CLOSED: ${{ inputs.skipClosedPlaces }}
          SEARCH_MATCHING: ${{ inputs.searchMatching }}
          MIN_STARS: ${{ inputs.placeMinimumStars }}
          WEBSITE_FILTER: ${{ inputs.website }}
        run: |
          # Properly split comma-separated string into a real JSON array
          IFS=',' read -ra SEARCH_ARRAY <<< "$SEARCH_STRINGS"
          SEARCH_JSON=$(printf '%s\n' "${SEARCH_ARRAY[@]}" | jq -R . | jq -s -c .)

          cat << EOF > input.json
          {
            "countryCode": "$COUNTRY_CODE",
            "deeperCityScrape": $DEEPER_CITY,
            "language": "$LANGUAGE",
            "locationQuery": "$LOCATION",
            "maxCrawledPlacesPerSearch": $MAX_PLACES,
            "searchStringsArray": $SEARCH_JSON,
            "skipClosedPlaces": $SKIP_CLOSED,
            "searchMatching": "$SEARCH_MATCHING",
            "placeMinimumStars": ${MIN_STARS:-0},
            "website": "$WEBSITE_FILTER"
          }
          EOF

          echo "Generated input.json:"
          cat input.json | jq .

      - name: Run Apify Google Maps Extractor (sync)
        env:
          APIFY_TOKEN: ${{ secrets.APIFY_TOKEN }}
        run: |
          echo "Calling Apify Google Maps Extractor..."
          curl -s -X POST \
            "https://api.apify.com/v2/acts/compass~google-maps-extractor/run-sync-get-dataset-items?token=$APIFY_TOKEN&memory=8192" \
            -H "Content-Type: application/json" \
            --data @input.json \
            -o results.json

          RESULT_COUNT=$(jq '. | length' results.json)
          echo "Apify returned $RESULT_COUNT places"

          if [ "$RESULT_COUNT" -eq 0 ]; then
            echo "No results returned â€“ check your search parameters"
            exit 1
          fi

      - name: Send results to Clay
        env:
          CLAY_WEBHOOK: ${{ secrets.CLAY_WEBHOOK }}
        run: |
          echo "Sending $(jq '. | length' results.json) rows to Clay..."
          curl -X POST "$CLAY_WEBHOOK" \
            -H "Content-Type: application/json" \
            --data @results.json

          # Gentle delay so Clay can breathe if payload is huge
          sleep 2

          echo "All done! Leads are now in your Clay table."
